version: "3.9"

services:
  # --- BASE DE DATOS ---
  db:
    image: postgres:15-alpine
    container_name: sgac_db
    restart: always
    environment:
      POSTGRES_DB: ${DB_NAME:-sgac_db}
      POSTGRES_USER: ${DB_USER:-sgac_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-sgac_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-sgac_user} -d ${DB_NAME:-sgac_db}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- CACHÉ Y COLAS ---
  redis:
    image: redis:7-alpine
    container_name: sgac_redis
    restart: always
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- APLICACIÓN WEB (DJANGO) ---
  web:
    build: .
    container_name: sgac_web
    restart: unless-stopped
    # Comando de desarrollo: Migra y levanta runserver (mejor para debug que gunicorn)
    # Si prefieres gunicorn local, cambia 'runserver 0.0.0.0:8000' por 'gunicorn ... --reload'
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py runserver 0.0.0.0:8000
      "
    volumes:
      - .:/app              # Montar código local para Hot-Reload
      - ./media:/app/media  # Persistencia de archivos subidos
      - ./logs:/app/logs    # Logs accesibles desde fuera
    ports:
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  # --- WORKER ASÍNCRONO (CELERY) ---
  worker:
    build: .
    container_name: sgac_celery
    restart: unless-stopped
    # Ejecuta el worker de Celery
    command: celery -A config worker -l info
    volumes:
      - .:/app
      - ./media:/app/media
      - ./logs:/app/logs
    env_file:
      - .env
    depends_on:
      - web
      - redis
      - db
  
  jenkins:
    image: jenkins/jenkins:lts
    container_name: sgac_jenkins
    restart: unless-stopped
    user: root 
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock 
    depends_on:
      - web
  
  sonarqube:
    image: sonarqube:community
    container_name: sgac_sonarqube
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    depends_on:
      - db

volumes:
  postgres_data:
  jenkins_home:
  sonarqube_data:       
  sonarqube_extensions: 
  sonarqube_logs:       