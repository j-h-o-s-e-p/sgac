{% extends 'base.html' %}
{% load static %}
{% load l10n %} {# Cargar localización para arreglar números #}

{% block title %}Estadísticas - Secretaría{% endblock %}

{% block extra_css %}
    <link href="{% static 'css/secretaria.css' %}" rel="stylesheet">
{% endblock %}

{% block sidebar %}
    {% include 'includes/secretaria_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="page-header-sec">
    <h1 class="h3 fw-bold text-dark mb-0">Estadísticas y Análisis</h1>
    <p class="text-muted mb-0">Métricas clave del desempeño académico e infraestructura</p>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="sec-stat-card card-blue">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="text-muted small fw-bold text-uppercase">Estudiantes</h6>
                    <h2 class="mb-0 fw-bold">{{ total_students }}</h2>
                </div>
                <div class="sec-icon-circle"><i class="bi bi-people-fill"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="sec-stat-card card-teal">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="text-muted small fw-bold text-uppercase">Cursos</h6>
                    <h2 class="mb-0 fw-bold">{{ total_courses }}</h2>
                </div>
                <div class="sec-icon-circle"><i class="bi bi-book-fill"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="sec-stat-card card-purple">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="text-muted small fw-bold text-uppercase">Profesores</h6>
                    <h2 class="mb-0 fw-bold">{{ total_professors }}</h2>
                </div>
                <div class="sec-icon-circle"><i class="bi bi-person-badge-fill"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="sec-stat-card card-orange">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="text-muted small fw-bold text-uppercase">Ratio Alumno/Curso</h6>
                    {# Usamos floatformat para evitar decimales largos #}
                    <h2 class="mb-0 fw-bold">{{ avg_class_size|floatformat:0 }}</h2>
                </div>
                <div class="sec-icon-circle"><i class="bi bi-pie-chart-fill"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom py-3">
                <h6 class="fw-bold m-0 text-primary"><i class="bi bi-pie-chart me-2"></i>Estado de Ocupación de Grupos</h6>
            </div>
            <div class="card-body">
                <div class="sec-chart-container">
                    <canvas id="saturationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom py-3">
                <h6 class="fw-bold m-0 text-success"><i class="bi bi-bar-chart-line me-2"></i>Top 10 Cursos por Matrícula</h6>
            </div>
            <div class="card-body">
                <div class="sec-chart-container">
                    <canvas id="courseChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white border-bottom py-3">
        <h6 class="fw-bold m-0 text-info"><i class="bi bi-clock-history me-2"></i>Carga Docente (Horas Semanales)</h6>
    </div>
    <div class="card-body">
        <div class="sec-chart-container-lg">
            <canvas id="professorsChart"></canvas>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom py-3">
                <h6 class="fw-bold m-0 text-warning"><i class="bi bi-journal-check me-2"></i>Avance de Sílabos</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 small">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Curso</th>
                                <th class="text-center">Sesiones</th>
                                <th class="text-center" style="width: 40%;">Progreso</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in syllabus_progress %}
                            <tr>
                                <td class="ps-3">
                                    <div class="fw-bold">{{ item.course_code }}</div>
                                    <div class="text-muted text-truncate" style="max-width: 150px;">{{ item.course_name }}</div>
                                </td>
                                <td class="text-center">{{ item.completed }} / {{ item.total }}</td>
                                <td class="pe-3">
                                    <div class="progress progress-custom">
                                        {# IMPORTANTE: Usamos unlocalize o stringformat para que el CSS entienda el número (punto en vez de coma) #}
                                        <div class="progress-bar {% if item.progress < 30 %}bg-danger{% elif item.progress < 70 %}bg-warning{% else %}bg-success{% endif %}"
                                             role="progressbar" 
                                             style="width: {{ item.progress|stringformat:'d' }}%;"
                                             aria-valuenow="{{ item.progress|stringformat:'d' }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ item.progress|floatformat:0 }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center py-3 text-muted">No hay datos disponibles</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-bottom py-3">
                <h6 class="fw-bold m-0 text-secondary"><i class="bi bi-building me-2"></i>Ocupación de Salones</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 small">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Salón</th>
                                <th>Cap.</th>
                                <th class="text-end pe-3">Bloques</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for classroom in classrooms_usage %}
                            <tr>
                                <td class="ps-3 fw-bold">{{ classroom.name }}</td>
                                <td>{{ classroom.capacity }}</td>
                                <td class="text-end pe-3">
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary">
                                        {{ classroom.usage_count }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ saturation_json|json_script:"data-saturation" }}
{{ students_by_course_json|json_script:"data-courses" }}
{{ professors_load_json|json_script:"data-professors" }}

<script src="{% static 'js/secretaria.js' %}"></script>
{% endblock %}