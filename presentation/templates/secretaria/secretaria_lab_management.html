{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Gestión de Laboratorios - Secretaría{% endblock %}

{% block extra_css %}
    <link href="{% static 'css/secretaria.css' %}" rel="stylesheet">
{% endblock %}

{% block sidebar %}
    {% include 'includes/secretaria_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="page-header-sec d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 fw-bold text-dark mb-0">Gestión de Laboratorios</h1>
        <p class="text-muted mb-0">Administración de grupos prácticos y asignación de docentes</p>
    </div>
    <input type="hidden" id="url-check-conflicts" value="{% url 'presentation:secretaria_lab_check_conflicts' %}">
</div>

{% for course_data in courses_data %}
<div class="card shadow-sm border-0 mb-4 rounded-3 overflow-hidden lab-course-card" 
     id="card-{{ course_data.course.course_id }}">
    
    <div class="card-header py-3 {% if course_data.has_all_labs %}bg-success bg-opacity-10{% else %}bg-warning bg-opacity-10{% endif %} border-0">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <span class="badge {% if course_data.has_all_labs %}bg-success{% else %}bg-warning text-dark{% endif %} me-2">
                        {{ course_data.course.course_code }}
                    </span>
                    <h5 class="mb-0 fw-bold text-dark">{{ course_data.course.course_name }}</h5>
                </div>
                <div class="text-muted small mt-1 ms-1">
                    <i class="bi bi-layers me-1"></i> Ciclo {{ course_data.course.cycle }} &nbsp;|&nbsp; 
                    <i class="bi bi-clock me-1"></i> {{ course_data.course.syllabus.lab_hours }}h Lab &nbsp;|&nbsp; 
                    <i class="bi bi-people me-1"></i> {{ course_data.enrollment_count }} Alumnos &nbsp;|&nbsp;
                    <i class="bi bi-box me-1"></i> {{ course_data.total_capacity }} Cupos
                </div>
            </div>
            <div class="col-md-4 text-end">
                {% if course_data.campaign_status.is_closed %}
                    <span class="badge bg-secondary rounded-pill px-3 py-2">
                        <i class="bi bi-lock-fill me-1"></i> Cerrado
                    </span>
                {% elif course_data.campaign_status.is_active %}
                    <span class="badge bg-info rounded-pill px-3 py-2">
                        <i class="bi bi-hourglass-split me-1"></i> En Matricula
                    </span>
                {% elif course_data.has_all_labs %}
                    <span class="badge bg-success rounded-pill px-3 py-2">
                        <i class="bi bi-check-circle-fill me-1"></i> Completo
                    </span>
                {% else %}
                    <span class="badge bg-warning text-dark rounded-pill px-3 py-2">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i> 
                        Falta {{ course_data.labs_needed|subtract:course_data.existing_labs.count }} lab(s)
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card-body bg-white">
        
        {% if course_data.campaign_status.is_active %}
        <div class="campaign-info-box">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 fw-bold"><i class="bi bi-megaphone me-2"></i>Matricula Activa</h6>
                    <small>Desde {{ course_data.campaign_status.start_date|slice:":10" }} hasta {{ course_data.campaign_status.end_date|slice:":10" }}</small>
                </div>
                <form method="post" action="{% url 'presentation:secretaria_lab_close_enrollment' course_data.course.course_id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-light btn-sm fw-bold" 
                            onclick="return confirm('¿Cerrar Matricula?')">
                        <i class="bi bi-x-circle me-1"></i> Cerrar Matricula
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
        
        {% if course_data.existing_labs %}
        <div class="mb-4">
            <h6 class="fw-bold text-secondary text-uppercase small mb-3 border-bottom pb-2">
                <i class="bi bi-list-ul me-1"></i> Grupos Creados
            </h6>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-3">Grupo</th>
                            <th>Capacidad</th>
                            <th>Inscritos</th>
                            <th>Estado</th>
                            <th>Horario</th>
                            <th>Salón</th>
                            <th>Profesor</th>
                            <th class="text-end pe-3">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lab in course_data.existing_labs %}
                        {% with lab_status=course_data.campaign_status.labs|selectattr:'lab_id'|first %}
                        <tr class="{% if course_data.campaign_status.is_closed %}locked-lab{% endif %}">
                            <td class="ps-3"><span class="badge bg-primary">Lab {{ lab.lab_nomenclature }}</span></td>
                            <td>{{ lab.capacity }} alum.</td>
                            <td>
                                {% if course_data.campaign_status.exists %}
                                    {% for lab_info in course_data.campaign_status.labs %}
                                        {% if lab_info.lab_id == lab.lab_id|stringformat:"s" %}
                                            <strong>{{ lab_info.enrolled }}</strong>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if course_data.campaign_status.exists %}
                                    {% for lab_info in course_data.campaign_status.labs %}
                                        {% if lab_info.lab_id == lab.lab_id|stringformat:"s" %}
                                            <span class="badge lab-status-badge status-{{ lab_info.status }}">
                                                {% if lab_info.status == 'empty' %}Vacío
                                                {% elif lab_info.status == 'normal' %}Normal
                                                {% elif lab_info.status == 'almost-full' %}Casi lleno
                                                {% elif lab_info.status == 'exceeded' %}Sobrepasado
                                                {% endif %}
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="fw-bold">{{ lab.get_day_of_week_display }}</div>
                                <small class="text-muted">{{ lab.start_time|time:"H:i" }} - {{ lab.end_time|time:"H:i" }}</small>
                            </td>
                            <td>
                                {% if lab.room %}
                                    <span class="text-dark"><i class="bi bi-geo-alt me-1"></i>{{ lab.room.name }}</span>
                                {% else %}
                                    <span class="text-danger small fw-bold">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if lab.professor %}
                                    {{ lab.professor.get_full_name }}
                                {% elif lab.external_professor %}
                                    {{ lab.external_professor.full_name }}
                                    <span class="badge bg-secondary badge-custom ms-1">Externo</span>
                                {% else %}
                                    <span class="text-muted">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-3">                      
                                {% if not course_data.campaign_status.is_closed %}
                                    <button type="button" 
                                            class="btn btn-sm btn-light text-danger border btn-delete-lab" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#confirmDeleteModal"
                                            data-url="{% url 'presentation:secretaria_lab_delete' lab.lab_id %}"
                                            data-name="Lab {{ lab.lab_nomenclature }} - {{ course_data.course.course_name }}">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <div class="d-flex gap-2">
            {% if not course_data.has_all_labs and not course_data.campaign_status.is_closed %}
            <button class="btn btn-outline-primary btn-sm fw-bold btn-toggle-lab-form" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapse-{{ course_data.course.course_id }}"
                    aria-expanded="false" 
                    aria-controls="collapse-{{ course_data.course.course_id }}">
                <i class="bi bi-plus-circle-fill me-2"></i> Crear Nuevo Grupo
            </button>
            {% endif %}
            
            {% if course_data.can_enable_enrollment and not course_data.campaign_status.exists %}
            <button type="button" 
                    class="btn btn-success btn-sm fw-bold"
                    data-bs-toggle="modal"
                    data-bs-target="#enableEnrollmentModal"
                    data-course-id="{{ course_data.course.course_id }}"
                    data-course-name="{{ course_data.course.course_code }}"
                    data-url-base="{% url 'presentation:secretaria_lab_enable_enrollment' course_data.course.course_id %}"
                <i class="bi bi-unlock-fill me-2"></i> Habilitar Matricula
            </button>
            {% endif %}
        </div>
        
        {% if not course_data.campaign_status.is_closed %}
        <div class="collapse mt-3" id="collapse-{{ course_data.course.course_id }}">
            <div class="card card-body bg-light border-0 rounded-3 p-4">
                <form method="post" action="{% url 'presentation:secretaria_lab_create' %}" 
                      class="lab-creation-form" 
                      id="form-{{ course_data.course.course_id }}"
                      data-course-id="{{ course_data.course.course_id }}">
                    {% csrf_token %}
                    <input type="hidden" name="course_id" value="{{ course_data.course.course_id }}">
                    
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Nomenclatura</label>
                            <select name="nomenclature" class="form-select form-select-sm" required>
                                <option value="">---</option>
                                <option value="A">Lab A</option>
                                <option value="B">Lab B</option>
                                <option value="C">Lab C</option>
                                <option value="D">Lab D</option>
                                <option value="E">Lab E</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Capacidad</label>
                            <input type="number" name="capacity" class="form-control form-control-sm capacity-input" required>
                            <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">Sugerido: <span class="suggested-capacity fw-bold">--</span></small>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Salón</label>
                            <select name="room_id" class="form-select form-select-sm lab-schedule-input">
                                <option value="">Sin asignar</option>
                                {% for classroom in classrooms %}
                                <option value="{{ classroom.classroom_id }}">
                                    {{ classroom.name }} ({{ classroom.capacity }} cap.)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Día</label>
                            <select name="day_of_week" class="form-select form-select-sm lab-schedule-input" required>
                                <option value="">---</option>
                                <option value="LUNES">Lunes</option>
                                <option value="MARTES">Martes</option>
                                <option value="MIERCOLES">Miércoles</option>
                                <option value="JUEVES">Jueves</option>
                                <option value="VIERNES">Viernes</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted">Horario</label>
                            <div class="input-group input-group-sm">
                                <input type="time" name="start_time" class="form-control lab-schedule-input" required>
                                <span class="input-group-text">-</span>
                                <input type="time" name="end_time" class="form-control lab-schedule-input" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-md-6 border-end">
                            <div class="form-check mb-2">
                                <input class="form-check-input prof-type-radio" type="radio" 
                                       name="professor_type" value="internal" checked
                                       data-target="internal">
                                <label class="form-check-label fw-bold">Profesor Interno</label>
                            </div>
                            <select name="professor_id" class="form-select form-select-sm internal-prof-select">
                                <option value="">-- Seleccionar Docente --</option>
                                <option value="" disabled class="bg-light text-muted">--- Docentes del Curso ---</option>
                                {% for prof in professors %}
                                    {% if prof.id in course_data.theory_professors_ids %}
                                        <option value="{{ prof.id }}" class="fw-bold text-primary bg-primary bg-opacity-10">
                                            ★ {{ prof.get_full_name }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                                <option value="" disabled class="bg-light text-muted">--- Otros Docentes ---</option>
                                {% for prof in professors %}
                                    {% if prof.id not in course_data.theory_professors_ids %}
                                        <option value="{{ prof.id }}">{{ prof.get_full_name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 ps-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input prof-type-radio" type="radio" 
                                       name="professor_type" value="external"
                                       data-target="external">
                                <label class="form-check-label fw-bold">Profesor Externo</label>
                            </div>
                            <input type="text" name="external_prof_name" class="form-control form-control-sm external-prof-input" 
                                   placeholder="Nombre completo" disabled>
                            <input type="hidden" name="use_external_professor" class="use-external-hidden" value="false">
                        </div>
                    </div>
                    
                    <div class="mt-3 text-end">
                        <button type="button" class="btn btn-sm btn-light border me-2" data-bs-toggle="collapse" 
                                data-bs-target="#collapse-{{ course_data.course.course_id }}">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-sm btn-success fw-bold">
                            <i class="bi bi-check-circle me-1"></i> Guardar Laboratorio
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% empty %}
<div class="alert alert-info border-0 shadow-sm d-flex align-items-center p-4">
    <i class="bi bi-info-circle-fill fs-3 me-3 text-info"></i> 
    <div>
        <h5 class="alert-heading fw-bold mb-1">No hay cursos configurados</h5>
        <p class="mb-0">No se encontraron cursos con horas de laboratorio.</p>
    </div>
</div>
{% endfor %}

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fs-6 fw-bold">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="text-muted mb-2">¿Estás seguro de eliminar este grupo?</p>
                <h5 class="fw-bold mb-0" id="modalLabName"></h5>
            </div>
            <div class="modal-footer justify-content-center bg-light border-0">
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger btn-sm px-4 fw-bold">Sí, Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="enableEnrollmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fs-6 fw-bold">Habilitar Inscripción de Laboratorio</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="enableEnrollmentForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body py-4">
                    <p class="mb-3">¿Por cuántos días estará disponible la inscripción?</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Duración (días)</label>
                        <input type="number" name="days_duration" class="form-control" value="7" min="1" max="30" required>
                        <small class="text-muted">Los alumnos podrán inscribirse durante este periodo</small>
                    </div>
                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Una vez habilitada, los alumnos podrán elegir su laboratorio. 
                        Puedes cerrar la inscripción cuando desees.
                    </div>
                </div>
                <div class="modal-footer justify-content-center bg-light border-0">
                    <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success btn-sm px-4 fw-bold">Habilitar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="enrolledStudentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fs-6 fw-bold" id="enrolledModalTitle">Alumnos Inscritos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="enrolledStudentsBody">
                </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/secretaria.js' %}"></script>
    <script src="{% static 'js/secretaria_lab.js' %}"></script>
{% endblock %}