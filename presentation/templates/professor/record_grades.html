{% extends 'base.html' %}

{% block title %}Registrar Notas - Profesor{% endblock %}

{% block sidebar %}
<li class="nav-item">
    <a class="nav-link" href="{% url 'presentation:professor_dashboard' %}">
        <i class="bi bi-house-door"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'presentation:professor_schedule' %}">
        <i class="bi bi-calendar3"></i> Mi Horario
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{% url 'presentation:professor_attendance' %}">
        <i class="bi bi-clipboard-check"></i> Asistencia
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{% url 'presentation:professor_grades' %}">
        <i class="bi bi-clipboard-data"></i> Notas
    </a>
</li>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'presentation:professor_grades' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-primary badge-custom">{{ course.course_code }}</span>
            {{ course.course_name }}
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <p class="mb-0">
                    <i class="bi bi-award"></i> <strong>Créditos:</strong> {{ course.credits }}
                </p>
            </div>
            <div class="col-md-4">
                <p class="mb-0">
                    <i class="bi bi-layers"></i> <strong>Ciclo:</strong> {{ course.cycle }}
                </p>
            </div>
            <div class="col-md-4">
                <p class="mb-0">
                    <i class="bi bi-bookmark"></i> <strong>Tipo:</strong> {{ course.get_course_type_display }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Selector de Evaluación -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-list-check"></i> Selecciona la Evaluación</h6>
    </div>
    <div class="card-body">
        <form method="GET" action="">
            <div class="row align-items-end">
                <div class="col-md-10">
                    <label for="evaluation" class="form-label">Evaluación</label>
                    <select class="form-select" id="evaluation" name="evaluation" required>
                        <option value="">-- Selecciona una evaluación --</option>
                        {% for eval in evaluations %}
                        <option value="{{ eval.evaluation_id }}" {% if selected_evaluation and eval.evaluation_id == selected_evaluation.evaluation_id %}selected{% endif %}>
                            Unidad {{ eval.unit }} - {{ eval.name }} ({{ eval.get_evaluation_type_display }}) - {{ eval.percentage }}%
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Formulario de Notas -->
{% if selected_evaluation %}
<form method="POST">
    {% csrf_token %}
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
                <i class="bi bi-pencil-square"></i> 
                {{ selected_evaluation.name }} - Unidad {{ selected_evaluation.unit }}
            </h6>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Tipo:</strong> {{ selected_evaluation.get_evaluation_type_display }} |
                <strong>Peso:</strong> {{ selected_evaluation.percentage }}% |
                <strong>Rango válido:</strong> 0 - 20
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 15%;">Código</th>
                            <th>Estudiante</th>
                            <th style="width: 20%;">Nota</th>
                            <th style="width: 15%;">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in enrollments_with_grades %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td><strong>{{ item.enrollment.student.username }}</strong></td>
                            <td>{{ item.enrollment.student.get_full_name }}</td>
                            <td>
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    name="grade_{{ item.enrollment.enrollment_id }}"
                                    min="0" 
                                    max="20" 
                                    step="0.01"
                                    value="{% if item.grade %}{{ item.grade.raw_score }}{% endif %}"
                                    placeholder="0.00"
                                >
                            </td>
                            <td>
                                {% if item.grade %}
                                    <span class="badge {% if item.grade.rounded_score >= 11 %}bg-success{% else %}bg-danger{% endif %} badge-custom">
                                        Registrado: {{ item.grade.rounded_score }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary badge-custom">Sin nota</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    {% if statistics %}
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Estadísticas</h6>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <h3 class="text-success">{{ statistics.max }}</h3>
                    <p class="text-muted mb-0">Nota Máxima</p>
                </div>
                <div class="col-md-3">
                    <h3 class="text-danger">{{ statistics.min }}</h3>
                    <p class="text-muted mb-0">Nota Mínima</p>
                </div>
                <div class="col-md-3">
                    <h3 class="text-primary">{{ statistics.avg }}</h3>
                    <p class="text-muted mb-0">Promedio</p>
                </div>
                <div class="col-md-3">
                    <h3 class="text-info">{{ statistics.total }}</h3>
                    <p class="text-muted mb-0">Notas Registradas</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between">
        <a href="{% url 'presentation:professor_grades' %}" class="btn btn-outline-secondary btn-custom">
            <i class="bi bi-x-lg"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-primary btn-custom">
            <i class="bi bi-save"></i> Guardar Notas
        </button>
    </div>
</form>
{% endif %}

<script>
// Validar notas antes de enviar
document.querySelector('form[method="POST"]')?.addEventListener('submit', function(e) {
    const inputs = this.querySelectorAll('input[type="number"]');
    let hasError = false;
    
    inputs.forEach(input => {
        const value = parseFloat(input.value);
        if (input.value && (value < 0 || value > 20)) {
            hasError = true;
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    if (hasError) {
        e.preventDefault();
        alert('Por favor, verifica que todas las notas estén entre 0 y 20');
        return false;
    }
    
    if (!confirm('¿Estás seguro de guardar estas notas?')) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}